# Update api-config.json on gh-pages so the live site gets the current tunnel URL after cloud reboot.
# Trigger from cloud with: gh workflow run "Update API config (gh-pages)" -f api_url="https://xxx.trycloudflare.com"
name: Update API config (gh-pages)

on:
  schedule:
    - cron: '*/2 * * * *'
  workflow_dispatch:
    inputs:
      api_url:
        description: 'Tunnel URL (optional; if set, used instead of curling cloud)'
        required: false
        type: string

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Resolve tunnel URL
        id: get_url
        env:
          INPUT_URL: ${{ github.event.inputs.api_url }}
        run: |
          if [ -n "$INPUT_URL" ]; then
            echo "url=$INPUT_URL" >> $GITHUB_OUTPUT
            echo "Using URL from workflow input"
          else
            RAW=$(curl -sf "http://150.241.244.130:10000/api/tunnel-url" 2>/dev/null || echo "")
            URL=$(echo "$RAW" | node -e "const d=require('fs').readFileSync(0,'utf8').trim(); try { console.log(JSON.parse(d).tunnelUrl||d); } catch(e) { console.log(d); }" 2>/dev/null || echo "$RAW" | tr -d '\n\r')
            if [ -z "$URL" ]; then
              echo "::warning::Could not reach cloud and no input URL â€” skipping update"
            fi
            echo "url=$URL" >> $GITHUB_OUTPUT
          fi

      - name: Checkout gh-pages
        if: steps.get_url.outputs.url != ''
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Write api-config.json
        if: steps.get_url.outputs.url != ''
        env:
          API_URL: ${{ steps.get_url.outputs.url }}
        run: |
          node -e "console.log(JSON.stringify({apiBaseUrl: process.env.API_URL || ''}))" > api-config.json

      - name: Commit and push
        if: steps.get_url.outputs.url != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add api-config.json
          git diff --staged --quiet && echo "No change" || (git commit -m "chore: update api-config.json" && git push)
