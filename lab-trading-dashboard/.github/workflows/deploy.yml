# Deploy lab-trading-dashboard to Ubuntu VM on push to main.
# Requires GitHub Secrets: SSH_HOST, SSH_USER, SSH_KEY.
# Optional: SSH_PORT (default 22), APP_PATH (default /opt/apps/<repo-name>).
# See docs/GITHUB_AUTO_SYNC.md for step-by-step setup.

name: Deploy to Ubuntu

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT || 22 }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            REPO_DIR="${{ github.event.repository.name }}"
            APP_PATH="${{ secrets.APP_PATH }}"
            [ -z "$APP_PATH" ] && APP_PATH="/opt/apps/${REPO_DIR}"
            if [ ! -d "$APP_PATH" ]; then
              echo "Error: $APP_PATH not found. Set secret APP_PATH to your app dir (e.g. /opt/apps/lab-trading-dashboard) or clone repo there."
              exit 1
            fi
            cd "$APP_PATH"
            if [ -x ./deploy.sh ]; then
              ./deploy.sh
            else
              git fetch origin main
              git reset --hard origin/main
              npm ci
              VITE_API_BASE_URL= npm run build
              cd server && npm ci && cd ..
              cp -f server/server.example.js server/server.js
              sudo systemctl enable lab-trading-dashboard
              sudo systemctl restart lab-trading-dashboard
              echo "Deploy done."
            fi
